#!/bin/bash
#PBS -P CFP01-CF-060
#PBS -j oe
#PBS -k oed
#PBS -N mt_eval
#PBS -M e1583535@u.nus.edu
#PBS -q auto
#PBS -m abe
#PBS -l select=1:ngpus=2
#PBS -l walltime=128:00:00

cd $PBS_O_WORKDIR;

src=zh
tgt=en
src2=zho_simpl
tgt2=eng
fixed=en-zh
custom=zh
lang=$src-$tgt
fs_task=$lang
tst=/scratch/e1583535/my-mt/datasets/flores101/devtest
fs_data=/scratch/e1583535/my-mt/fs-data-bin/$fixed
fs_chkpts=/scratch/e1583535/my-mt/fs-checkpoints/$fs_task
fs_res=/scratch/e1583535/my-mt/fs-results/$fs_task
FSROOT=/scratch/e1583535/my-mt/lib/fairseq/fairseq_cli
LIB=/scratch/e1583535/my-mt/lib
SCRIPTS=$LIB/mosesdecoder/scripts
TOKENIZER=$SCRIPTS/tokenizer/tokenizer.perl
DETOKENIZER=$SCRIPTS/tokenizer/detokenizer.perl
TOKENIZER_CUSTOM=$LIB/custom-tokenizers/$custom/tokenize.py
DETOKENIZER_CUSTOM=$LIB/custom-tokenizers/$custom/detokenize.py
orig=/scratch/e1583535/my-mt/fs-data/$fixed
prep=$orig/prep
BPE_CODE=$prep/code

image="/app1/common/singularity-img/hopper/cuda/cuda_12.1.0-cudnn8-devel-u20.04.sif"

module load singularity

BASE_LOG_DIR=/scratch/e1583535/my-mt/logs

mkdir -p $BASE_LOG_DIR/eval/en-zh

singularity exec -e \
--env HF_HOME=/scratch/e1583535/cache \
--env HF_DATASETS_CACHE=/scratch/e1583535/cache/datasets \
$image bash << EOF > $BASE_LOG_DIR/eval/en-zh/stdout.$PBS_JOBID.log 2> $BASE_LOG_DIR/eval/en-zh/stderr.$PBS_JOBID.log

source /hpctmp/e1583535/virtualenvs/fairseq-env/bin/activate

echo "generating with fairseq..."
mkdir -p $fs_res/tmp

export CUDA_VISIBLE_DEVICES=0,1

if [ "$src" == "$custom" ]; then
        grep '' $tst/$src2.devtest | \
            python $TOKENIZER_CUSTOM > $fs_res/tmp/test.$src.tok
    else
        grep '' $tst/$src2.devtest | \
            perl $TOKENIZER -threads 8 -a -l $src > $fs_res/tmp/test.$src.tok
    fi

checkpoints=("_best")

for c in "\${checkpoints[@]}"; do
    echo "evaluating checkpoint-\${c}..."
    
    if [ "$src" == "$custom" ]; then
        cat $fs_res/tmp/test.$src.tok | \
        python $FSROOT/interactive.py $fs_data \
            --path $fs_chkpts/checkpoint\$c.pt \
            --beam 5 --source-lang $src --target-lang $tgt \
            --user-dir $LIB/rdrop \
            --remove-bpe --bpe subword_nmt --bpe-codes $BPE_CODE > $fs_res/generate-test-\$c.txt
    else
        cat $tst/$src2.devtest | \
        python $FSROOT/interactive.py $fs_data \
            --path $fs_chkpts/checkpoint\$c.pt \
            --beam 5 --source-lang $src --target-lang $tgt \
            --user-dir $LIB/rdrop --tokenizer moses \
            --remove-bpe --bpe subword_nmt --bpe-codes $BPE_CODE > $fs_res/generate-test-\$c.txt
    fi

    if [ "$tgt" == "$custom" ]; then
        grep ^D- $fs_res/generate-test-\$c.txt | sort -V | cut -f3 | \
            python $DETOKENIZER_CUSTOM > $fs_res/translations-\$c.txt
    else
        grep ^D- $fs_res/generate-test-\$c.txt | sort -V | cut -f3 | \
            perl $DETOKENIZER -threads 8 -l $tgt > $fs_res/translations-\$c.txt
    fi

    echo "checkpoint-\${c} evaluation completed"
    sleep 10
done

echo "computing evaluation scores..."

for c in "\${checkpoints[@]}"; do
   bleu=\$(cat "$fs_res/translations-\${c}.txt" | sacrebleu "$tst/$tgt2.devtest" -b -l "$lang" -m bleu)
   chrf=\$(cat "$fs_res/translations-\${c}.txt" | sacrebleu "$tst/$tgt2.devtest" -b -l "$lang" -m chrf --chrf-word-order 2)
   cmet=\$(comet-score -s "$tst/$src2.devtest" -r "$tst/$tgt2.devtest" -t "$fs_res/translations-\${c}.txt" --quiet --only_system | awk -F 'score: ' '{print $2}')
   echo "$lang $src2-$tgt2 (checkpoint-\${c}) -- BLEU: \$bleu; chrF++: \$chrf; COMET-22: \$cmet"
done

echo "Done at $(date)"

EOF